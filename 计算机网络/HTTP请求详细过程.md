# HTTP请求的全过程

## 请求过程

* 输入url
* 域名解析
* 与服务器建立连接
* 发起HTTP请求
* 服务器响应HTTP请求，浏览器得到html代码
* 浏览器解析html代码，并请求html代码中的资源（如js、css、图片）
* 浏览器对页面进行渲染呈现给用户

## 网页渲染的过程

* 用户输入url
* 获取相应对应的资源
* 渲染引擎调用资源加载器加载相应资源
* HTML解析器生成DOM树
* JavaScript代码由JavaScript引擎处理
* CSS解析出Style Rules（生成CSSOM）
* DOM树建立后根据CSS样式进行构建内部绘图模型，生成RenderObject树
* 根据网页层次结构构建RenderLayer树，同时构建虚拟绘图上下文
* 依赖2D和3D图形库渲染成图像结果呈现在浏览器中（Painting）

## 详细版 从输入 URL 到页面加载完成的过程

这是一个很经典的面试题，在这题中可以将本文讲得内容都串联起来。

* 首先做 DNS 查询，如果这一步做了智能 DNS 解析的话，会提供访问速度最快的 IP 地址回来
* 接下来是 TCP 握手，应用层会下发数据给传输层，这里 TCP 协议会指明两端的端口号，然后下发给网络层。网络层中的 IP 协议会确定 IP 地址，并且指示了数据传输中如何跳转路由器。然后包会再被封装到数据链路层的数据帧结构中，最后就是物理层面的传输了
* TCP 握手结束后会进行 TLS 握手，然后就开始正式的传输数据
* 数据在进入服务端之前，可能还会先经过负责负载均衡的服务器，它的作用就是将请求合理的分发到多台服务器上，这时假设服务端会响应一个 HTML 文件
* 首先浏览器会判断状态码是什么，如果是 200 那就继续解析，如果 400 或 500 的话就会报错，如果 300 的话会进行重定向，这里会有个重定向计数器，避免过多次的重定向，超过次数也会报错
* 浏览器开始解析文件，如果是 gzip 格式的话会先解压一下，然后通过文件的编码格式知道该如何去解码文件
* 文件解码成功后会正式开始渲染流程，先会根据 HTML 构建 DOM 树，有 CSS 的话会去构建 CSSOM 树。如果遇到 script 标签的话，会判断是否存在 async 或者 defer ，前者会并行进行下载并执行 JS，后者会先下载文件，然后等待 HTML 解析完成后顺序执行，如果以上都没有，就会阻塞住渲染流程直到 JS 执行完毕。遇到文件下载的会去下载文件，这里如果使用 HTTP 2.0 协议的话会极大的提高多图的下载效率。
* 初始的 HTML 被完全加载和解析后会触发 DOMContentLoaded 事件
* CSSOM 树和 DOM 树构建完成后会开始生成 Render 树，这一步就是确定页面元素的布局、样式等等诸多方面的东西
* 在生成 Render 树的过程中，浏览器就开始调用 GPU 绘制，合成图层，将内容显示在屏幕上了
