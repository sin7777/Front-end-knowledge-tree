# å›¾ç‰‡æ‡’åŠ è½½

![å›¾ç‰‡æ‡’åŠ è½½](../images/å›¾ç‰‡æ‡’åŠ è½½.png)

å›¾ç‰‡æ‡’åŠ è½½çš„åŸç†

* å›¾ç‰‡å…ˆç”¨å ä½ç¬¦è¡¨ç¤ºï¼Œsrcå±æ€§ç”¨ä¸€å¼ é»˜è®¤å›¾ç‰‡
* æŠŠçœŸæ­£çš„å›¾ç‰‡åœ°å€æ”¾åœ¨`data-src` å±æ€§é‡Œé¢
* é¡µé¢åŠ è½½å®Œæˆä¹‹åï¼Œç›‘å¬çª—å£æ»šåŠ¨
* å½“å›¾ç‰‡å‡ºç°åœ¨è§†å›¾ä¸­æ—¶ï¼Œèµ‹å€¼çœŸæ­£çš„åœ°å€src

## imgæ ‡ç­¾è‡ªå®šä¹‰å±æ€§ç›¸å…³

```HTML
<img class="lazy" src="" data-src="" alt="image"/>
```

## åˆ¤æ–­å…ƒç´ è¿›å…¥è§†å£viewportæ–¹æ³•

* å›¾ç‰‡è·ç¦»é¡¶éƒ¨è·ç¦» < è§†çª—é«˜åº¦ + é¡µé¢æ»šåŠ¨é«˜åº¦

```JS
function isInViewport(ele){
    ele.offsetTop < window.innerHeight + document.body.scrollTop
}
```

* getBoundingClientRect

Element.getBoundingClientRect()æ–¹æ³•è¿”å›å…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹äºè§†å£çš„ä½ç½®

```JS
function isInViewport(ele) {
  // å…ƒç´ é¡¶éƒ¨ è·ç¦» è§†å£å·¦ä¸Šè§’ çš„è·ç¦»top <= çª—å£é«˜åº¦ ï¼ˆåä¾‹ï¼šå…ƒç´ åœ¨å±å¹•ä¸‹æ–¹çš„æƒ…å†µï¼‰
  // å…ƒç´ åº•éƒ¨ è·ç¦» è§†å£å·¦ä¸Šè§’ çš„è·ç¦»bottom > 0 (åä¾‹ï¼šå…ƒç´ åœ¨å±å¹•ä¸Šæ–¹çš„æƒ…å†µ)
  // å…ƒç´ displayæ ·å¼ä¸ä¸ºnone
  const notBelow = ele.getBoundingClientRect().top <= window.innerHeight ? true : false;
  const notAbove = ele.getBoundingClientRect().bottom >= 0 ? true : false;
  const visable = getComputedStyle(ele).display !== "none" ? true : false;
  return notBelow && notAbove && visable ? true : false;
}
```

* IntersectionObserver

IntersectionObserver API æ˜¯ç”¨æ¥ç›‘è§†æŸä¸ªå…ƒç´ æ˜¯å¦æ»šåŠ¨è¿›äº†æµè§ˆå™¨çª—å£çš„å¯è§†åŒºåŸŸï¼ˆè§†å£ï¼‰æˆ–è€…æ»šåŠ¨è¿›äº†å®ƒçš„æŸä¸ªç¥–å…ˆå…ƒç´ çš„å¯è§†åŒºåŸŸå†…ã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯ç”¨æ¥å®ç°**æ‡’åŠ è½½**å’Œ**é¡µé¢æ— é™æ»šåŠ¨**ã€‚

ğŸ‘‰[è¯¦æƒ…è¯·çœ‹](../HTML/IntersectionObserver.md)ğŸ‘ˆ

## å…·ä½“é€»è¾‘

```JS
function LazyLoad() {
  // è¿™ä¸ªactiveæ˜¯èŠ‚æµthrottleæ‰€ç”¨çš„æ ‡å¿—ä½ï¼Œè¿™é‡Œç”¨åˆ°äº†é—­åŒ…çŸ¥è¯†
  let active = false;

  const lazyLoad = () => {
    // throttleç›¸å…³ï¼š200mså†…åªä¼šæ‰§è¡Œä¸€æ¬¡lazyLoadæ–¹æ³•
    if (active) return;
    active = true;

    setTimeout(() => {
      // è·å–æ‰€æœ‰classä¸ºlazyçš„imgæ ‡ç­¾ï¼Œè¿™é‡Œç”±äºä¹‹å‰å·²ç»æŠŠå¤„ç†è¿‡çš„imgæ ‡ç­¾çš„classåˆ æ‰äº†  æ‰€ä»¥ä¸ä¼šé‡å¤æŸ¥æ‰¾
      let lazyImages = [].slice.call(document.querySelectorAll("img.lazy"));

      lazyImages.forEach(lazyImage => {
        // åˆ¤æ–­å…ƒç´ æ˜¯å¦è¿›å…¥viewport
        if (isInViewport(lazyImage)) {
          // <img class="lazy" src="[å ä½å›¾]" data-src="[çœŸå®urlåœ°å€]" data-srcset="[ä¸åŒå±å¹•å¯†åº¦ä¸‹ï¼Œä¸åŒçš„urlåœ°å€]" alt="I'm an image!">
          // ele.dataset.* å¯ä»¥è¯»å–è‡ªå®šä¹‰å±æ€§é›†åˆï¼Œæ¯”å¦‚data-*
          // img.srcset å±æ€§ç”¨äºè®¾ç½®ä¸åŒå±å¹•å¯†åº¦ä¸‹ï¼Œimageè‡ªåŠ¨åŠ è½½ä¸åŒçš„å›¾ç‰‡  æ¯”å¦‚<img src="image-128.png" srcset="image-256.png 2x" />
          lazyImage.src = lazyImage.dataset.src;
          lazyImage.srcset = lazyImage.dataset.srcset;
          // åˆ é™¤class  é˜²æ­¢ä¸‹æ¬¡é‡å¤æŸ¥æ‰¾åˆ°æ”¹imgæ ‡ç­¾
          lazyImage.classList.remove("lazy");
        }

        // å½“å…¨éƒ¨å¤„ç†å®Œäº†ï¼Œç§»é™¤ç›‘å¬
        if (lazyImages.length === 0) {
          document.removeEventListener("scroll", lazyLoad);
          window.removeEventListener("resize", lazyLoad);
          window.removeEventListener("orientationchange", lazyLoad);
        }
      })

      active = false;
    }, 200);
  }

  document.addEventListener("scroll", lazyLoad);
  document.addEventListener("resize", lazyLoad);
  document.addEventListener("orientationchange", lazyLoad);
}
```
